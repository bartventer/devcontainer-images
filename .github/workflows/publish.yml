# This workflow uses the `devcontainer` CLI to build the Docker image.
# We chose the `devcontainer` CLI because we need integration with Dev Containers in Visual Studio Code.
# As a result, we're not using Docker's `buildx` command for multi-architecture builds.
# This workflow will only build the image for the host architecture (x86-64).
name: Publish

on:
  workflow_dispatch:
    inputs:
      imageName:
        type: choice
        options:
          - 'archlinux'
          # ... add more images here
        description: 'The name of the image to build and push'
        required: true

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install devcontainer CLI
      run: |
        echo "ğŸ“¦ Installing devcontainer CLI..."
        npm install -g @devcontainers/cli
        echo "âœ… devcontainer CLI installed successfully."

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get latest version
      id: latest-version
      shell: bash
      run: |
        echo "ğŸ” Getting the latest version of the image from GitHub Container Registry..."
        JSON_RESPONSE=$(curl -s https://ghcr.io/v2/${{ github.repository_owner }}/${{ github.event.inputs.imageName }}/tags/list)
        if jq -e . >/dev/null 2>&1 <<<"$JSON_RESPONSE"; then
          LATEST_VERSION=$(echo $JSON_RESPONSE | jq -r '.tags[]' | sort -V | tail -n 1)
        else
          LATEST_VERSION="0.0.0"
        fi
        echo "âœ… Latest version: $LATEST_VERSION"
        echo "version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
            
    - name: Compare versions
      id: compare-versions
      shell: bash
      run: |
        echo "ğŸ” Comparing the new version with the latest version..."
        VERSION=$(cat src/${{ github.event.inputs.imageName }}/VERSION)
        LATEST_VERSION=${{ steps.latest-version.outputs.version }}
        echo "ğŸ†• New version: $VERSION"
        echo "ğŸ”µ Latest version: $LATEST_VERSION"
        if [[ $(printf '%s\n' "$VERSION" "$LATEST_VERSION" | sort -V | head -n 1) = "$VERSION" ]]; then
          echo "valid=false" >> $GITHUB_OUTPUT
          echo "âŒ Error: The new version ($VERSION) is not larger than the current version ($LATEST_VERSION)."
        else
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… The new version ($VERSION) is larger than the current version ($LATEST_VERSION). Proceeding with the build..."
        fi
      
    - name: Build Docker image for x86-64 on ${{ github.event.inputs.imageName }}
      if: steps.compare-versions.outputs.valid == 'true'
      shell: bash
      env:
        DOCKER_BUILDKIT: 1
      run: |
        echo "ğŸ—ï¸ Building Docker image for x86-64 on ${{ github.event.inputs.imageName }}..."
        cd src/${{ github.event.inputs.imageName }}/.devcontainer
        # Build the image for the new version and the latest version
        for tag in ${{ steps.compare-versions.outputs.version }} latest; do
          devcontainer build --tag ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.imageName }}:$tag
          echo "âœ… Docker image built successfully for tag $tag."
        done
      
    - name: Push Docker image for x86-64 on ${{ github.event.inputs.imageName }}
      shell: bash
      if: steps.compare-versions.outputs.valid == 'true'
      run: |
        echo "ğŸš€ Pushing Docker image for x86-64 on ${{ github.event.inputs.imageName }}..."
        # Push the image for the new version and the latest version
        for tag in ${{ steps.compare-versions.outputs.version }} latest; do
          docker push ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.imageName }}:$tag
          echo "âœ… Docker image pushed successfully for tag $tag."
        done